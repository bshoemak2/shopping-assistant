{% extends "base.html" %}
{% block content %}
    <div class="image-container">
        <img src="{{ url_for('static', filename='funny_image_2.jpg') }}" alt="Cyberpunk Shopper Chaos" class="funny-image">
        <img src="{{ url_for('static', filename='funny_image_4.jpg') }}" alt="Neon Bargain Hunt" class="funny-image">
    </div>
    <p class="disclosure">As an Amazon Associate, I earn from qualifying purchases.</p>
    <video class="promo-video" controls>
        <source src="{{ url_for('static', filename='fart_chicken/EmojiMovie764632741.MOV') }}" type="video/mp4">
        Your browser does not support the video tag.
    </video>
    <div class="mystery-product-section">
        <button class="mystery-button" onclick="revealMysteryProduct()">Reveal Mystery Product!</button>
        <div class="mystery-product" id="mysteryProduct"></div>
    </div>

    <div class="product-section" id="wearable-pranks">
        <h2>Wearable Pranks</h2>
        <p>Gag gifts you can wear to cause a scene!</p>
        {% include 'product_list.html' with products=wearable_pranks %}
    </div>

    <div class="product-section" id="desk-disasters">
        <h2>Desk Disasters</h2>
        <p>Pranks to chaos-ify your workspace!</p>
        {% include 'product_list.html' with products=desk_disasters %}
    </div>

    <div class="product-section" id="home-hilarity">
        <h2>Home Hilarity</h2>
        <p>Gag gifts to turn your home into a prank zone!</p>
        {% include 'product_list.html' with products=home_hilarity %}
    </div>

    <p class="hacks-prompt" id="all-products">Browse All Gag Gifts!</p>
    {% include 'product_list.html' with products=all_products %}

    <div class="product-section">
        <h2>ðŸŽ‰ Best Gag Gift for Your Brotherâ€™s Wedding</h2>
        <p>Add some humor to the big day with these hilarious picks!</p>
        <ul>
            <li><a href="https://amzn.to/4kQ39A7" target="_blank" onclick="trackAffiliateClick('Fart Whistles (Wedding)')">Fart Whistles - Loads of Fun for the Reception</a></li>
            <li><a href="https://amzn.to/4kVaBtW" target="_blank" onclick="trackAffiliateClick('Expresso Cups in Poo Colors (Wedding)')">Expresso Cups in Poo Colors - A Crappy Gift for a Laugh</a></li>
            <li><a href="https://amzn.to/4hAMdL5" target="_blank" onclick="trackAffiliateClick('Rubber Chicken Purse (Wedding)')">Rubber Chicken Purse - Cluck in Style at the After-Party</a></li>
        </ul>
    </div>

    <div class="product-section">
        <h2>ðŸ¤¡ Funny Office Prank Ideas for April Fools</h2>
        <p>Make your coworkers laugh with these prank-ready products!</p>
        <ul>
            <li><a href="https://amzn.to/4hEoA4v" target="_blank" onclick="trackAffiliateClick('Fake Poop (Office)')">Fake Poop - Leave It on a Desk for a Scream</a></li>
            <li><a href="https://amzn.to/4l41QNZ" target="_blank" onclick="trackAffiliateClick('Silly String Shooter (Office)')">Silly String Shooter - Spray Chaos in the Break Room</a></li>
            <li><a href="https://amzn.to/4i5b2PL" target="_blank" onclick="trackAffiliateClick('Giant Googly Eyes (Office)')">Giant Googly Eyes - Stick Them on Office Supplies</a></li>
        </ul>
    </div>

    <h1>FIND PRODUCTS WITH PRICE, RATING AND REVIEWS</h1>
    <p class="prompt">Enter products below and filter your search:</p>
    <div id="find-form">
        <input type="text" id="product-input" placeholder="Enter products (e.g., laptop, yoga mat)">
        <select id="filter">
            <option value="all">All</option>
            <option value="under-20">Under $20</option>
            <option value="top-rated">Top Rated (4+)</option>
        </select>
        <button class="btn" onclick="findProducts()">FIND PRODUCTS</button>
    </div>
    <div id="results"></div>
    <p class="searchable">Searchable Products: laptop, yoga mat, beef tallow, more products coming soon</p>

    <div class="reviews-section">
        <h2>Prankster Reviews</h2>
        <p>Share your prank success story!</p>
        <form id="review-form" onsubmit="submitReview(event)">
            <textarea name="review" placeholder="Tell us how your prank went!" required></textarea>
            <button type="submit" class="btn">Submit Review</button>
        </form>
        <div id="reviews-list">
            <p>"Left the Fake Poop on my bossâ€™s deskâ€”screamed like a banshee! 10/10" - PrankMaster3000</p>
        </div>
    </div>

    <div class="email-signup">
        <h2>JOIN THE PRANK PARTY! ðŸŽ‰</h2>
        <p>Get "The Ultimate Prank Cheat Sheet" for FREE and never miss a laugh!</p>
        <form action="{{ url_for('subscribe') }}" method="POST">
            <input type="email" name="email" placeholder="Enter your email" required>
            <button type="submit" class="btn">Sign Me Up for the Shenanigans!</button>
        </form>
        <p style="font-size: 0.75rem; margin-top: 10px;">
            By signing up, you agree to our <a href="/privacy">Privacy Policy</a> and to receive monthly prank ideas and Amazon product recommendations.
        </p>
    </div>
    <p>Contact us for issues and suggestions: <a href="mailto:bshoemak@mac.com">bshoemak@mac.com</a></p>
{% endblock %}

{% block scripts %}
    <script>
        function trackAffiliateClick(productName) {
            if (typeof twq !== 'undefined') {
                const eventData = {
                    value: 1.00,
                    currency: 'USD',
                    contents: productName,
                    conversion_id: 'affiliate-click-' + Date.now()
                };
                console.log('Tracking affiliate click:', JSON.stringify(eventData));
                twq('track', 'Custom', eventData);
            } else {
                console.error('Twitter pixel not loaded');
            }
        }

        function findProducts() {
            const input = document.getElementById('product-input').value;
            const filter = document.getElementById('filter').value;
            if (!input) {
                document.getElementById('results').innerHTML = '<p>Please enter products to find.</p>';
                return;
            }
            const products = input.split(',').map(p => p.trim());
            fetch('/find', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ products: products })
            })
            .then(response => {
                if (!response.ok) throw new Error('Network response was not ok');
                return response.json();
            })
            .then(data => {
                const results = document.getElementById('results');
                results.innerHTML = '';
                if (data.error) {
                    results.innerHTML = `<p>Error: ${data.error}</p>`;
                } else {
                    for (const [name, info] of Object.entries(data.comparisons)) {
                        if (filter === 'under-20' && info.price >= 20) continue;
                        if (filter === 'top-rated' && info.rating < 4) continue;
                        results.innerHTML += `
                            <h3>${name}</h3>
                            <p>Price: $${info.price}</p>
                            <p>Rating: ${info.rating}</p>
                            <p>Positive Reviews: ${info.review_summary.positive}</p>
                            <p>Negative Reviews: ${info.review_summary.negative}</p>
                            <p>Sentiment Score: ${info.review_summary.sentiment_score}</p>
                            <p>Keywords: ${JSON.stringify(info.review_summary.keywords)}</p>
                            <p><a href="${info.amazon_url}" target="_blank">Amazon Link</a> ${info.is_search_page ? '(Search Page)' : ''}</p>
                        `;
                    }
                }
            })
            .catch(error => {
                document.getElementById('results').innerHTML = `<p>Error: ${error.message}</p>`;
            });
        }

        function shareProduct(name, url) {
            const shareText = `Found this hilarious ${name} on Barlitoâ€™s Bazaar! Check it out: ${url} #BarlitosChaos`;
            if (navigator.share) {
                navigator.share({
                    title: name,
                    text: shareText,
                    url: url
                }).catch(err => console.error('Share failed:', err));
            } else {
                window.open(`https://twitter.com/intent/tweet?text=${encodeURIComponent(shareText)}`, '_blank');
            }
        }

        function vote(productId, change) {
            const scoreElement = document.querySelector(`.fun-stuff-score[data-id="${productId}"] .score-value`);
            let score = parseInt(scoreElement.textContent);
            score = Math.max(0, Math.min(10, score + change));
            scoreElement.textContent = score;
            localStorage.setItem(`fun-stuff-score-${productId}`, score);
        }

        function revealMysteryProduct() {
            const mysteryProduct = { name: "Fart Whistles, Loads of Fun", url: "https://amzn.to/4kQ39A7" };
            const mysteryDiv = document.getElementById('mysteryProduct');
            mysteryDiv.innerHTML = `Mystery Product: <a href="${mysteryProduct.url}" target="_blank" onclick="trackAffiliateClick('Fart Whistles (Mystery)')">${mysteryProduct.name}</a>`;
            mysteryDiv.style.display = 'block';
        }

        function submitReview(event) {
            event.preventDefault();
            const reviewText = document.querySelector('#review-form textarea').value;
            const reviewsList = document.getElementById('reviews-list');
            reviewsList.innerHTML += `<p>"${reviewText}" - Anonymous Prankster</p>`;
            document.querySelector('#review-form').reset();
        }

        document.addEventListener('DOMContentLoaded', () => {
            document.querySelectorAll('.fun-stuff-score').forEach(element => {
                const productId = element.getAttribute('data-id');
                const savedScore = localStorage.getItem(`fun-stuff-score-${productId}`);
                if (savedScore !== null) {
                    element.querySelector('.score-value').textContent = savedScore;
                }
            });
        });
    </script>
{% endblock %}